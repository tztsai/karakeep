---
description: 
globs: *.tsx,*.ts,*.js,*.md,*.sh
alwaysApply: false
---
## ğŸš€ What is Karakeep?

**Karakeep** (previously Hoarder) is a self-hostable, full-featured bookmark and note-taking app with AI-powered features, designed for â€œdata hoarders.â€ It supports links, notes, images, PDFs, and more, with automatic metadata fetching, full-text search, AI tagging, OCR, and multi-platform support (web, mobile, browser extension, REST API).

---

## ğŸ—ï¸ Monorepo Structure

Karakeep uses a **Turborepo** monorepo with `pnpm` workspaces. Key directories:

â”œâ”€â”€ apps/                # All deployable applications (web, mobile, CLI, etc.)
â”‚   â”œâ”€â”€ web/             # Next.js web app
â”‚   â”‚   â”œâ”€â”€ app/         # App router pages and layouts
â”‚   â”‚   â”œâ”€â”€ components/  # React UI components
â”‚   â”‚   â”œâ”€â”€ lib/         # Utilities, hooks, helpers
â”‚   â”‚   â”œâ”€â”€ public/      # Static assets
â”‚   â”‚   â”œâ”€â”€ server/      # Server-side logic (API handlers, etc.)
â”‚   â”‚   â”œâ”€â”€ @types/      # TypeScript types
â”‚   â”‚   â”œâ”€â”€ ...          # Configs: next.config.mjs, tailwind.config.ts, etc.
â”‚   â”‚
â”‚   â”œâ”€â”€ mobile/          # React Native (Expo) mobile app
â”‚   â”‚   â”œâ”€â”€ app/         # App entry and navigation
â”‚   â”‚   â”œâ”€â”€ components/  # UI components
â”‚   â”‚   â”œâ”€â”€ lib/         # Utilities, hooks
â”‚   â”‚   â”œâ”€â”€ plugins/     # Native plugins/integrations
â”‚   â”‚   â”œâ”€â”€ assets/      # Images, fonts, sounds
â”‚   â”‚   â”œâ”€â”€ android/     # Android-specific files
â”‚   â”‚   â”œâ”€â”€ ...          # Configs: app.json, tailwind.config.ts, etc.
â”‚   â”‚
â”‚   â”œâ”€â”€ browser-extension/ # Chrome/Firefox extension
â”‚   â”‚   â”œâ”€â”€ src/         # Source code
â”‚   â”‚   â”œâ”€â”€ public/      # Static assets
â”‚   â”‚   â”œâ”€â”€ dist/        # Build output
â”‚   â”‚   â”œâ”€â”€ ...          # Configs: manifest.json, tailwind.config.js, etc.
â”‚   â”‚
â”‚   â”œâ”€â”€ cli/             # Command-line interface
â”‚   â”‚   â”œâ”€â”€ src/         # CLI source code
â”‚   â”‚   â”œâ”€â”€ dist/        # Build output
â”‚   â”‚   â””â”€â”€ ...          # Configs
â”‚   â”‚
â”‚   â”œâ”€â”€ workers/         # Background workers (jobs, queues)
â”‚   â”‚   â”œâ”€â”€ workers/     # Worker scripts
â”‚   â”‚   â”œâ”€â”€ ...          # Utilities, configs
â”‚   â”‚
â”‚   â””â”€â”€ mcp/             # (Likely admin/control panel)
â”‚       â”œâ”€â”€ src/         # Source code
â”‚       â”œâ”€â”€ dist/        # Build output
â”‚       â””â”€â”€ ...          # Configs
â”‚
â”œâ”€â”€ packages/            # Shared libraries, backend, and core logic
â”‚   â”œâ”€â”€ api/             # Hono-based REST API
â”‚   â”‚   â”œâ”€â”€ routes/      # API route handlers (tags, lists, users, etc.)
â”‚   â”‚   â”œâ”€â”€ middlewares/ # API middlewares (auth, etc.)
â”‚   â”‚   â”œâ”€â”€ utils/       # API utilities (pagination, types)
â”‚   â”‚   â””â”€â”€ index.ts     # API entry point
â”‚   â”‚
â”‚   â”œâ”€â”€ db/              # Drizzle ORM database schema and access
â”‚   â”‚   â”œâ”€â”€ schema.ts    # Main DB schema (users, bookmarks, tags, etc.)
â”‚   â”‚   â”œâ”€â”€ drizzle/     # Drizzle migrations/config
â”‚   â”‚   â”œâ”€â”€ ...          # DB utilities, config, migration scripts
â”‚   â”‚
â”‚   â”œâ”€â”€ trpc/            # tRPC routers for type-safe API
â”‚   â”‚   â”œâ”€â”€ routers/     # Routers for bookmarks, users, tags, etc.
â”‚   â”‚   â”œâ”€â”€ models/      # Data models
â”‚   â”‚   â”œâ”€â”€ lib/         # Helpers/utilities
â”‚   â”‚   â””â”€â”€ index.ts     # tRPC entry point
â”‚   â”‚
â”‚   â”œâ”€â”€ shared/          # Shared code (types, utils, config)
â”‚   â”‚   â”œâ”€â”€ types/       # TypeScript types (bookmarks, tags, etc.)
â”‚   â”‚   â”œâ”€â”€ utils/       # Utility functions
â”‚   â”‚   â””â”€â”€ ...          # Config, logger, prompts, search, etc.
â”‚   â”‚
â”‚   â”œâ”€â”€ shared-react/    # Shared React components, hooks, providers
â”‚   â”‚   â”œâ”€â”€ hooks/       # React hooks
â”‚   â”‚   â”œâ”€â”€ providers/   # React context providers
â”‚   â”‚   â”œâ”€â”€ utils/       # React utilities
â”‚   â”‚
â”‚   â”œâ”€â”€ sdk/             # SDK for external integrations or clients
â”‚   â”‚
â”‚   â”œâ”€â”€ open-api/        # OpenAPI spec and related code
â”‚   â”‚
â”‚   â””â”€â”€ e2e_tests/       # End-to-end tests
â”‚
â”œâ”€â”€ docs/                # Project documentation
â”œâ”€â”€ notes/               # Project notes, ideas, and planning
â”œâ”€â”€ docker/              # Docker-related files
â”œâ”€â”€ kubernetes/          # Kubernetes deployment files
â”œâ”€â”€ screenshots/         # App screenshots and logos
â”œâ”€â”€ tooling/             # Dev tooling/scripts
â””â”€â”€ ...                  # Other configs (.gitignore, .prettierrc, pnpm-workspace.yaml, turbo.json, etc.)

## ğŸ“± **Applications (apps/)**

### **1. Web App (`apps/web/`)**
- **Framework**: Next.js 14 with App Router
- **State Management**: Zustand
- **Forms**: React Hook Form + Zod validation
- **Rich Text**: Lexical editor
- **PWA**: Next-PWA for offline capabilities
- **Internationalization**: i18next

### **2. Mobile App (`apps/mobile/`)**
- **Framework**: Expo (React Native)
- **Styling**: NativeWind (Tailwind for React Native)
- **Navigation**: Expo Router
- **UI Components**: Custom components with Lucide icons

### **3. Other Apps**
- **CLI** - Command-line interface
- **Browser Extension** - Chrome/Firefox extension
- **Workers** - Background job processing
- **Landing Page** - Marketing site
- **MCP** - Model Context Protocol integration

## ğŸ“¦ **Shared Packages (`packages/`)**

### **Database (`packages/db/`)**
- **ORM**: Drizzle ORM
- **Database**: SQLite (Better-SQLite3)
- **Migrations**: Drizzle Kit
- **Schema**: Type-safe database schemas

### **API Layer (`packages/trpc/`)**
- **tRPC** - End-to-end typesafe APIs
- **Authentication**: bcryptjs for password hashing
- **Validation**: Zod schemas
- **Serialization**: SuperJSON

### **Shared Libraries**
- **`shared`** - Common utilities and types
- **`shared-react`** - React-specific shared components
- **`api`** - API definitions
- **`sdk`** - Client SDK
- **`open-api`** - OpenAPI specifications

## ğŸ› ï¸ **Development Tools**

### **Code Quality**
- **TypeScript** - Type safety across the stack
- **ESLint** - Linting with custom configs
- **Prettier** - Code formatting
- **Vitest** - Testing framework

### **Build & Deploy**
- **Docker** - Containerization
- **Kubernetes** - Orchestration configs
- **GitHub Actions** - CI/CD pipeline

## ğŸ”§ **Key Technologies**

### **Frontend Stack**
- **React 18** with modern hooks
- **Next.js 14** with App Router
- **Tailwind CSS** for styling
- **Radix UI** for accessible components
- **TanStack Query** for server state management

### **Backend Stack**
- **tRPC** for type-safe API calls
- **Drizzle ORM** with SQLite
- **NextAuth.js** for authentication
- **Puppeteer** for web scraping
- **Meilisearch** for full-text search

### **AI & Processing**
- **OpenAI** integration for auto-tagging and summarization
- **Ollama** support for local models
- **OCR** for text extraction from images
- **Monolith** for full-page archival

---

## ğŸ—„ï¸ Database (Drizzle ORM, SQLite)

### **Core Entities**

- **users**: User accounts (id, name, email, password, role, etc.)
- **accounts, sessions, verificationTokens**: For authentication (NextAuth-compatible)
- **apiKeys**: For user-specific API access

### **Bookmarks & Content**

- **bookmarks**: The main entity (id, userId, title, type, archived, favourited, note, summary, etc.)
- **bookmarkLinks**: Link-specific metadata (url, title, description, author, publisher, image, favicon, HTML content, crawl status, etc.)
- **bookmarkTexts**: For text notes (text, sourceUrl)
- **bookmarkAssets**: For files (images, PDFs, etc.) attached to bookmarks

### **Organization & Metadata**

- **bookmarkTags**: User-defined tags (name, userId, createdAt)
- **tagsOnBookmarks**: Many-to-many between bookmarks and tags (attachedBy: `ai` or `human`)
- **bookmarkLists**: Lists/folders for organizing bookmarks (manual or smart, with query support, parentId for nesting)
- **bookmarksInLists**: Many-to-many between bookmarks and lists

### **Assets & Highlights**

- **assets**: All uploaded files (id, assetType, size, contentType, fileName, bookmarkId, userId)
- **highlights**: User highlights on bookmarks (startOffset, endOffset, color, text, note)

### **Other Tables**

- **customPrompts**: User-defined AI prompts for tagging/summarization
- **rssFeedsTable**: RSS feed integrations (name, url, enabled, lastFetchedAt, etc.)

### **Migrations**

- Located in `packages/db/drizzle/` as SQL files, managed by Drizzle.

---

## ğŸ› ï¸ Backend Architecture

### **API Layers**

#### 1. **REST API (Hono)**
- Located in `packages/api/routes/`
- Each file (e.g., `bookmarks.ts`, `tags.ts`, `lists.ts`, `users.ts`, `assets.ts`, `highlights.ts`) defines endpoints for CRUD and advanced operations.
- Uses Zod for validation, and custom middlewares for authentication.

#### 2. **tRPC API**
- Located in `packages/trpc/routers/`
- Type-safe, auto-typed API for frontend and other clients
- Routers for all major entities: `bookmarks`, `tags`, `lists`, `users`, `assets`, `highlights`, `feeds`, `prompts`, `admin`, etc.
- Each router exposes queries and mutations, e.g.:
  - `createBookmark`, `getBookmarks`, `updateBookmark`, `deleteBookmark`
  - `addTag`, `removeTag`, `searchBookmarks`, etc.
- Handles business logic, validation, and DB access

#### 3. **Shared Logic**
- `packages/shared/` contains types, utility functions, config, search logic, AI integration, etc.
- `packages/shared-react/` contains React-specific hooks and providers for consuming tRPC and shared logic.

### **Workers & Background Jobs**

- `apps/workers/` runs background jobs for:
  - Crawling links (Puppeteer)
  - AI tagging (OpenAI/local models)
  - OCR (Tesseract)
  - Search indexing (Meilisearch)
  - Rule engine, webhooks, etc.

---

## ğŸ† Best Practices

- Use consistent code style (Prettier, ESLint)
- Modular, reusable components
- Robust error handling
- Accessibility and responsive design
- Write meaningful comments and documentation

---

## ğŸ’¡ Pro Tips

- Check `ui-redesign.md` in `apps/mobile/` for the latest mobile UX plans.
